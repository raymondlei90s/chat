"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(){function t(t){return"string"!=typeof t&&t.length?t[Math.floor(Math.random()*t.length)]:t}function n(){setTimeout(function(){e();var t=$("#mobile-body-content .msg-row:last-child .msg");t.find("a").attr("target","_blank"),s(t).then(e)})}function e(){var t=$("#mobile-body-content"),n=t[0].scrollHeight-t.height()-t.scrollTop(),e=Date.now();requestAnimationFrame(function i(){var o=Math.min(1,(Date.now()-e)/250);t.scrollTop(t.scrollTop()+n*o),o<1&&requestAnimationFrame(i)})}function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(function(n){setTimeout(n,t)})}function o(){var t=$("#mock-msg");return{width:t.width(),height:t.height()}}function s(t){return new Promise(function(n){t.one("load",n).each(function(t,n){n.complete&&$(n).trigger("load")})})}var r={LEI:"lei",ME:"me"};new Vue({el:"#mobile",data:{messages:[],dialogs:null,lastDialog:null,msgChain:Promise.resolve(),isLeiTyping:!1,nextTopics:[],hasPrompt:!1,latestMsgContent:null},mounted:function(){var t=this;$.getJSON("./assets/dialog.json",function(n){t.dialogs=n,t.nextTopics=t.dialogs.fromUser,t.appendDialog("0000")})},methods:{appendDialog:function(n){var e=this;if("object"===(void 0===n?"undefined":_typeof(n))&&n.length>0)n.forEach(function(t){return e.appendDialog(t)});else{if(null!=n){this.isLeiTyping=!0;var o=this.getDialog(n);return t(o.details).forEach(function(t){e.msgChain=e.msgChain.then(function(){return i(700)}).then(function(){return e.sendMsg(t,r.LEI)})}),o.nextLeiResp?this.appendDialog(o.nextLeiResp):this.msgChain.then(function(){e.lastDialog=o,e.isLeiTyping=!1})}this.lastDialog.responses=null}},sendMsg:function(t,n){switch(n){case r.ME:return this.sendUserMsg(t);default:return this.sendFriendMsg(t,n)}},sendFriendMsg:function(o,s){var r=this,a=t(o),u=a.replace(/<[^>]+>/g,"").length,l=/<img[^>]+>/.test(a),c=u>5||l,g={author:s,content:c?'\n    <div class="dot"></div>\n    <div class="dot"></div>\n    <div class="dot"></div>\n  ':a,isImg:l};return this.messages.push(g),c?(this.markMsgSize(g),setTimeout(e),i(Math.min(100*u,2e3)).then(function(){return r.markMsgSize(g,a)}).then(function(){return i(150)}).then(function(){g.content=a,n()})):(n(),Promise.resolve())},sendUserMsg:function(t){return this.messages.push({author:r.ME,content:t}),n(),Promise.resolve()},markMsgSize:function(t){var n=this,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.latestMsgContent=e||t.content,i(0).then(function(){return t.isImg&&s($("#mock-msg img"))}).then(function(){Object.assign(t,o()),n.messages=[].concat(_toConsumableArray(n.messages))})},getDialog:function(t){var n=this.dialogs.fromLei.filter(function(n){return n.id===t});return n?n[0]:null},getDialogFromUser:function(t){var n=this.dialogs.fromUser.filter(function(n){return n.id===t});return n?n[0]:null},togglePrompt:function(t){this.isLeiTyping||(this.hasPrompt=t)},respond:function(t){return this.say(t.content,t.nextLeiResp)},ask:function(n){var e=t(n.details);return this.say(e,n.nextLeiResp)},say:function(t,n){var e=this;return this.hasPrompt=!1,i(200).then(function(){return e.sendMsg(t,r.ME)}).then(function(){return i(300)}).then(function(){return e.appendDialog(n)})}}})}();